{"Parameters": {"ApplicationInternalBastionSecurityGroup": {"Type": "String"}, "Environment": {"MinLength": "4", "AllowedPattern": "[a-z0-9]*", "ConstraintDescription": "Can contain 4 to 8 lower case alphanumeric characters.", "MaxLength": "8", "Description": "Name of the environment to launch services into.", "Type": "String"}, "PublicExternalDomain": {"Type": "String"}, "ApplicationName": {"Type": "String"}, "PrivateInternalDomain": {"Type": "String"}, "ApplicationVPCPrivateSubnets": {"Description": "Subnets to launch app into.", "Type": "String"}, "ApplicationVPCPublicSubnets": {"Description": "Subnets to launch app into.", "Type": "String"}, "LoadBalancerScheme": {"Default": "internet-facing", "Type": "String"}, "TemplateURLPrefix": {"Type": "String"}, "ApplicationVPC": {"Description": "VPC to launch this subnet into.", "Type": "AWS::EC2::VPC::Id"}, "BaseImageId": {"AllowedPattern": "ami-[a-z0-9]{8}", "ConstraintDescription": "Must be a valid ami id", "Type": "String"}, "LogglyToken": {"Type": "String"}, "Version": {"Default": "latest", "Type": "String"}, "PublicExternalHostedZone": {"Description": "Route53 Private Internal Hosted Zone for VPC.", "Type": "String"}, "LoadBalancerPort": {"Default": "443", "Type": "Number"}, "PrivateInternalHostedZone": {"Description": "Route53 Private Internal Hosted Zone for VPC.", "Type": "String"}, "NewRelicToken": {"Type": "String"}, "AvailabilityZones": {"Description": "AvailabilityZones to launch networking stacks into.", "Type": "String"}}, "Outputs": {"Version": {"Value": {"Ref": "Version"}}, "PublicEndPoint": {"Value": {"Fn::GetAtt": ["PublicDNSRecord", "Outputs.EndPoint"]}}, "PrivateEndPoint": {"Value": {"Fn::GetAtt": ["PrivateDNSRecord", "Outputs.EndPoint"]}}, "ApplicationName": {"Value": {"Ref": "ApplicationName"}}}, "AWSTemplateFormatVersion": "2010-09-09", "Description": "v1.0 Creates a Driver Portal service", "Resources": {"PrivateDNSRecord": {"Properties": {"Parameters": {"LoadBalancerScheme": {"Ref": "LoadBalancerScheme"}, "Environment": {"Ref": "Environment"}, "HostedZoneName": {"Ref": "PrivateInternalDomain"}, "LoadBalancerDNSHostedZoneName": {"Fn::GetAtt": ["Instances", "Outputs.DNSHostedZoneName"]}, "HostedZoneId": {"Ref": "PrivateInternalHostedZone"}, "ApplicationName": {"Ref": "ApplicationName"}, "LoadBalancerCanonicalHostedZoneNameID": {"Fn::GetAtt": ["Instances", "Outputs.CanonicalHostedZoneNameID"]}}, "TemplateURL": {"Fn::Join": ["/", [{"Ref": "TemplateURLPrefix"}, "services/web/web_record_set.json"]]}, "TimeoutInMinutes": "5"}, "Type": "AWS::CloudFormation::Stack"}, "PublicDNSRecord": {"Properties": {"Parameters": {"LoadBalancerScheme": {"Ref": "LoadBalancerScheme"}, "Environment": {"Ref": "Environment"}, "HostedZoneName": {"Ref": "PublicExternalDomain"}, "LoadBalancerDNSHostedZoneName": {"Fn::GetAtt": ["Instances", "Outputs.DNSHostedZoneName"]}, "HostedZoneId": {"Ref": "PublicExternalHostedZone"}, "ApplicationName": {"Ref": "ApplicationName"}, "LoadBalancerCanonicalHostedZoneNameID": {"Fn::GetAtt": ["Instances", "Outputs.CanonicalHostedZoneNameID"]}}, "TemplateURL": {"Fn::Join": ["/", [{"Ref": "TemplateURLPrefix"}, "services/web/web_record_set.json"]]}, "TimeoutInMinutes": "5"}, "Type": "AWS::CloudFormation::Stack"}, "StorageBuckets": {"Properties": {"Parameters": {"ApplicationName": {"Ref": "ApplicationName"}, "Environment": {"Ref": "Environment"}, "TemplateURLPrefix": {"Ref": "TemplateURLPrefix"}}, "TemplateURL": {"Fn::Join": ["/", [{"Ref": "TemplateURLPrefix"}, "services/web/s3/buckets.json"]]}, "TimeoutInMinutes": "5"}, "Type": "AWS::CloudFormation::Stack"}, "Instances": {"Properties": {"Parameters": {"InstanceType": "m3.medium", "InstanceHealthCheck": "/heartbeat", "ImageId": {"Ref": "BaseImageId"}, "TemplateURLPrefix": {"Ref": "TemplateURLPrefix"}, "LogglyToken": {"Ref": "LogglyToken"}, "Cooldown": "30", "UserData": {"Fn::Join": ["", ["docker run -d --name ", {"Ref": "ApplicationName"}, " --link consul:consul ridecharge/", {"Ref": "ApplicationName"}, ":", {"Ref": "Version"}, "\ndocker run -d --name nginx ", "-e SERVICE_NAME=", {"Ref": "ApplicationName"}, " --link ", {"Ref": "ApplicationName"}, ":app --link consul:consul --link logging:logging ", "-p 8080:8080 ridecharge/nginx\n"]]}, "NewRelicToken": {"Ref": "NewRelicToken"}, "LoadBalancerSubnets": {"Ref": "ApplicationVPCPublicSubnets"}, "AvailabilityZones": {"Ref": "AvailabilityZones"}, "Environment": {"Ref": "Environment"}, "DeployMinInstancesInService": "1", "Scheme": {"Ref": "LoadBalancerScheme"}, "ApplicationName": {"Ref": "ApplicationName"}, "DesiredCapacity": "2", "InstanceProfile": {"Fn::GetAtt": ["InstanceProfile", "Outputs.InstanceProfile"]}, "MaxSize": "2", "DeployMaxBatchSize": "1", "InstancePort": "8080", "LoadBalancerPort": "443", "LoadBalancerSecurityGroup": {"Fn::GetAtt": ["Security", "Outputs.LoadBalancerSecurityGroup"]}, "InstanceSubnets": {"Ref": "ApplicationVPCPrivateSubnets"}, "HealthCheckGracePeriod": "300", "InstanceSecurityGroups": {"Fn::Join": [",", [{"Fn::GetAtt": ["Security", "Outputs.InstanceSecurityGroup"]}, {"Ref": "ApplicationInternalBastionSecurityGroup"}]]}, "MinSize": "2"}, "TemplateURL": {"Fn::Join": ["/", [{"Ref": "TemplateURLPrefix"}, "services/web/web_autoscaling.json"]]}, "TimeoutInMinutes": "10"}, "Type": "AWS::CloudFormation::Stack"}, "Security": {"Properties": {"Parameters": {"ApplicationName": {"Ref": "ApplicationName"}, "LoadBalancerPort": "443", "Environment": {"Ref": "Environment"}, "Vpc": {"Ref": "ApplicationVPC"}}, "TemplateURL": {"Fn::Join": ["/", [{"Ref": "TemplateURLPrefix"}, "services/web/web_security.json"]]}, "TimeoutInMinutes": "5"}, "Type": "AWS::CloudFormation::Stack"}, "InstanceProfile": {"Properties": {"Parameters": {"ApplicationName": {"Ref": "ApplicationName"}, "Environment": {"Ref": "Environment"}}, "TemplateURL": {"Fn::Join": ["/", [{"Ref": "TemplateURLPrefix"}, "services/web/web_profile.json"]]}, "TimeoutInMinutes": "5"}, "Type": "AWS::CloudFormation::Stack"}}}