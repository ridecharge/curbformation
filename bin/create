#!/usr/bin/env python
import getopt
import sys
from enum import Enum
from boto import cloudformation


class Stack(object):

    class StackTypes(Enum):
        iam = 1
        network = 2

    STACK_DEPENDS_ON = "STACK_DEPENDS_ON"
    STACK_INPUTS = "STACK_INPUTS"
    STACK_CAPABILITIES = "STACK_CAPABILITIES"

    DEPENDENCIES = {
        StackTypes.network:
        {
            STACK_INPUTS: ["NATRoleProfileId"],
            STACK_DEPENDS_ON: [StackTypes.iam],
            STACK_CAPABILITIES: []
        },
        StackTypes.iam:
        {
            STACK_INPUTS: [],
            STACK_DEPENDS_ON: [],
            STACK_CAPABILITIES: ["CAPABILITY_IAM"]
        }
    }

    def __init__(self, type, env, region="us-east-1"):
        self.env = env
        self.type = type
        self.cf_conn = cloudformation.connect_to_region(region)

    def depends_on(self):
        if self.type not in Stack.DEPENDENCIES:
            return None
        stack_types = Stack.DEPENDENCIES[self.type][Stack.STACK_DEPENDS_ON]
        stacks = []
        for type in stack_types:
        	stacks.append(Stack(type, 'global' if type == Stack.StackTypes.iam else self.env))
        return stacks


    def capabilities(self):
        if self.type not in Stack.DEPENDENCIES:
            return None
        return Stack.DEPENDENCIES[self.type][Stack.STACK_CAPABILITIES]

    def inputs(self):
        if self.type not in Stack.DEPENDENCIES:
            return None
        return Stack.DEPENDENCIES[self.type][Stack.STACK_INPUTS]

    def stack_name(self):
        return self.env + "-" + self.type.name

    def template_uri(self):
        return "https://s3.amazonaws.com/curbformation-" + \
            self.env + "-templates/" + self.type.name + ".json"

    def params(self):
        if not self.depends_on():
            return None

        params = [("Environment", self.env)]
        for depend_stack in self.depends_on():
            params.extend(self.build_params(depend_stack))
        return params

    def build_params(self, depend_stack):
        params = []
        outputs = depend_stack.outputs
        inputs = self.inputs()
        for output in outputs:
            if output.key in inputs:
                params.append((output.key, output.value))
        return params

    def describe(self):
        return self.cf_conn.describe_stacks(self.stack_name())[0]

    def create(self):
        return self.cf_conn.create_stack(self.stack_name(), None, self.template_uri(), self.params(), None, None, 30, self.capabilities())


def usage():
    print("Usage: " + sys.argv[0] + " ENV STACK")
    print("Valid STACK values: iam, network")
    sys.exit(0)


def main(env, type):
    # hacky figure out what to do w/ global StackTypes
    if type == Stack.StackTypes.iam:
        env = 'global'
    stack = Stack(type, env)
    stack.create()

if __name__ == "__main__":
    argv = sys.argv[1:]
    if len(argv) != 2 or not argv[0] or not argv[1]:
        usage()

    main(argv[0], Stack.StackTypes[argv[1]])
